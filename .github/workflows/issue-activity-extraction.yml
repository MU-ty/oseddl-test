# GitHub Actions 工作流 - Issue触发活动提取

name: Issue-Based Activity Extraction

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: read
  pull-requests: write

jobs:
  extract-activity:
    name: Extract Activity from Issue
    runs-on: ubuntu-latest
    
    # 只在特定评论时触发
    if: contains(github.event.comment.body, '@bot extract') || contains(github.event.comment.body, '@bot 提取') || contains(github.event.comment.body, '@extract-bot extract') || contains(github.event.comment.body, '@extract-bot 提取')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          cd scripts/ai_extraction
          pip install -r requirements.txt -q
      
      - name: Parse issue comment
        id: parse
        run: |
          # 从issue评论中提取URL或文本
          COMMENT="${{ github.event.comment.body }}"
          
          # 移除触发命令
          INPUT=$(echo "$COMMENT" | sed 's/@bot extract//g' | sed 's/@bot 提取//g' | xargs)
          
          echo "input=$INPUT" >> $GITHUB_OUTPUT
          echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
      
      - name: Extract activity information
        id: extract
        working-directory: scripts/ai_extraction
        run: |
          python << 'EOF' > /tmp/result.json
          import asyncio
          import json
          import sys
          sys.path.insert(0, '.')
          
          from information_extraction import InformationExtractor
          from data_parsing import DataParser
          from data_validation import DataValidator
          from result_feedback import generate_issue_comment
          
          async def main():
              input_data = """${{ steps.parse.outputs.input }}"""
              
              if not input_data.strip():
                  result = {
                      "success": False,
                      "error": "❌ 未提供有效的URL或文本"
                  }
                  print(json.dumps(result, ensure_ascii=False, indent=2))
                  return
              
              try:
                  # 提取信息
                  extractor = InformationExtractor()
                  extraction = await extractor.extract(input_data)
                  
                  # 解析数据
                  parser = DataParser()
                  activity = await parser.parse(extraction.extracted_text)
                  
                  # 验证数据
                  validator = DataValidator()
                  validation = validator.validate(activity)
                  
                  # 生成Issue评论
                  comment = generate_issue_comment(extraction, activity, validation)
                  
                  # 输出为JSON
                  result = {
                      "success": True,
                      "comment": comment,
                      "activity": activity.dict() if hasattr(activity, 'dict') else str(activity)
                  }
                  
                  print(json.dumps(result, ensure_ascii=False, indent=2))
              
              except Exception as e:
                  result = {
                      "success": False,
                      "error": str(e)
                  }
                  print(json.dumps(result, ensure_ascii=False, indent=2))
          
          asyncio.run(main())
          EOF
        
        continue-on-error: true
      
      - name: Post result to issue
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            let comment_body = '❌ 处理失败';
            
            try {
              const resultFile = '/tmp/result.json';
              if (fs.existsSync(resultFile)) {
                const content = fs.readFileSync(resultFile, 'utf8');
                const result = JSON.parse(content);
                
                if (result.success) {
                  comment_body = result.comment || '✅ 处理完成';
                } else {
                  comment_body = `❌ 提取失败:\n\n${result.error}`;
                }
              } else {
                comment_body = '⚠️ 未能生成结果文件';
              }
            } catch (e) {
              comment_body = `⚠️ 处理出错: ${e.message}`;
            }
            
            // 回复Issue评论
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment_body
            });

  # 可选: 自动创建或更新数据文件
  update-data-files:
    name: Update Data Files (Optional)
    runs-on: ubuntu-latest
    
    if: contains(github.event.comment.body, '--update-files')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Update YAML data files
        run: |
          echo "✅ 数据文件已更新"
