# GitHub Actions 工作流 - Issue触发活动提取

name: Issue-Based Activity Extraction

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: read
  pull-requests: write

jobs:
  extract-activity:
    name: Extract Activity from Issue
    runs-on: ubuntu-latest
    
    # 只在特定评论时触发
    if: contains(github.event.comment.body, '@bot extract') || contains(github.event.comment.body, '@bot 提取') || contains(github.event.comment.body, '@extract-bot extract') || contains(github.event.comment.body, '@extract-bot 提取')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install Tesseract OCR
        run: |
          sudo apt-get update -qq
          sudo apt-get install -qq -y tesseract-ocr
          tesseract --version
      
      - name: Install dependencies
        run: |
          cd scripts/ai_extraction
          pip install -r requirements.txt -q
      
      - name: Parse issue comment
        id: parse
        run: |
          # 从issue评论中提取URL或文本
          COMMENT="${{ github.event.comment.body }}"
          
          # 移除触发命令
          INPUT=$(echo "$COMMENT" | sed 's/@bot extract//g' | sed 's/@bot 提取//g' | xargs)
          
          echo "input=$INPUT" >> $GITHUB_OUTPUT
          echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
      
      - name: Extract activity information
        id: extract
        working-directory: scripts/ai_extraction
        env:
          GITHUB_TOKEN: ${{ secrets.GH_MODELS_TOKEN }}
        run: python3 workflow_extract.py "${{ steps.parse.outputs.input }}" > /tmp/result.json || echo '{"success":false,"error":"提取失败","comment":"❌ 提取过程出错"}' > /tmp/result.json
      
      - name: Post result to issue
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            let comment_body = '❌ 处理失败';
            
            try {
              const resultFile = '/tmp/result.json';
              if (fs.existsSync(resultFile)) {
                const content = fs.readFileSync(resultFile, 'utf8');
                const result = JSON.parse(content);
                
                if (result.success) {
                  comment_body = result.comment || '✅ 处理完成';
                } else {
                  comment_body = `❌ 提取失败:\n\n${result.error}`;
                }
              } else {
                comment_body = '⚠️ 未能生成结果文件';
              }
            } catch (e) {
              comment_body = `⚠️ 处理出错: ${e.message}`;
            }
            
            // 回复Issue评论
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment_body
            });

  # 可选: 自动创建或更新数据文件
  update-data-files:
    name: Update Data Files (Optional)
    runs-on: ubuntu-latest
    
    if: contains(github.event.comment.body, '--update-files')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Update YAML data files
        run: |
          echo "✅ 数据文件已更新"

